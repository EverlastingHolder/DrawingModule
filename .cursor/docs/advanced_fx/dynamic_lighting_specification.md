# Спецификация динамического освещения (Gyroscope Lighting)

**Статус**: ✅ ПРОЕКТ (Advanced FX)
**Версия**: 1.0 (2026-02-04)

Документ описывает систему динамического освещения холста на основе датчиков движения устройства (гироскоп/акселерометр).

---

## 1. Концепция Dynamic Lighting

Цель — имитировать изменение бликов на материалах (кожа, глиттер, влажные поверхности) при изменении наклона устройства пользователем.

### 1.1 Поток данных
1.  **CoreMotion**: Приложение считывает `CMDeviceMotion` (Pitch, Roll, Yaw).
2.  **CPU Logic**: Перевод углов наклона в вектор света $\vec{L}$ в мировых координатах холста.
3.  **Uniform Update**: Передача $\vec{L}$ в `ResidencySnapshot` каждого кадра.
4.  **GPU Shading**: Расчет освещения в реальном времени внутри Compositor.

---

## 2. Математическая модель

Мы используем упрощенную модель Блинна-Фонга для расчета бликов.

### 2.1 Вектор освещения
Вектор света $\vec{L}$ вычисляется так, чтобы "лампа" находилась за плечом пользователя:
```swift
let lightDir = SIMD3<Float>(
    Float(sin(roll)), 
    Float(sin(pitch)), 
    -Float(cos(pitch) * cos(roll))
).normalized()
```

### 2.2 Расчет Specular (Бликов)
В фрагментном шейдере композитинга:
$I_{spec} = ( \vec{N} \cdot \vec{H} )^n$
Где:
*   $\vec{N}$ — нормаль поверхности (из `Material Map`).
*   $\vec{H}$ — вектор полупути (Half-way vector).
*   $n$ — коэффициент блеска (Shininess).

---

## 3. Эффект мерцания (Sparkle Effect)

Для глиттера расчет дополняется функцией острого пика:
```metal
float sparkle = pow(max(dot(facetNormal, lightDir), 0.0), 128.0);
if (sparkle > 0.9) {
    color.rgb += sparkle * lightColor * exposure;
}
```

---

## 4. Пост-обработка: HDR и Bloom

Для того чтобы блики выглядели "физически яркими", используется HDR-конвейер.

### 4.1 Bloom Pass
1.  **Threshold**: Выделение пикселей с яркостью $> 1.0$.
2.  **Downsample & Blur**: Многоуровневое размытие по Гауссу.
3.  **Additive Blend**: Наложение размытого свечения на оригинальный кадр.
4.  **Tonemapping (ACES)**: Сжатие динамического диапазона для вывода на экран.

**Адаптивность**:
*   **Ultra/Pro**: Полноценный многопроходный Bloom.
*   **Legacy**: Этап Bloom пропускается или заменяется на простейший блик (Simple Glow) без размытия для сохранения бюджета кадра.

---

## 5. Оптимизация

*   **Zero-Hopping**: Вектор света передается как часть `FrameContext`, что исключает `await` при рендеринге.
*   **Tile-based Lighting**: Расчет бликов происходит только для тайлов, имеющих флаг `hasMaterial` в `Global Occupancy Map`, что экономит до 70% вычислительной мощности на пустых областях.
