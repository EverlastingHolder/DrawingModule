# Спецификация материальных кистей: Глиттер и Блеск

**Статус**: ✅ ПРОЕКТ (Advanced FX)
**Версия**: 1.0 (2026-02-04)

Этот документ описывает реализацию кистей с физическими свойствами материалов, таких как прозрачный блеск для губ и глиттер (блестки).

---

## 1. Концепция: Кисть как материал

В отличие от стандартных кистей, которые меняют только цвет (`RGBA`), материальные кисти записывают данные в дополнительные каналы для последующего расчета освещения.

### 1.1 Многоканальные тайлы (Multi-channel Tiles)
Для реализации эффектов нам необходимо расширить структуру тайла. Каждый слой теперь может владеть двумя физическими текстурами:
1.  **Color Texture (Albedo)**: Основной цвет и прозрачность (`RGBA16Float`).
2.  **Attribute Texture (Material Map)**: Данные о физике поверхности (`RG8Unorm`).
    *   **Канал R (Roughness)**: Шероховатость. 0.0 — идеально гладкая поверхность (блеск), 1.0 — матовая.
    *   **Канал G (Sparkle/Facets)**: Плотность и ориентация частиц глиттера.

---

## 2. Реализация блеска для губ (Lip Gloss)

Блеск характеризуется высокой прозрачностью и сильным "влажным" бликом.

### 2.1 Алгоритм отрисовки
1.  **Splatting**: Кисть рисует в `Color Texture` с низким значением `alpha` (эффект прозрачного геля).
2.  **Material Write**: Одновременно в `Attribute Texture` записывается значение `Roughness = 0.0`.
3.  **Shading**: В финальном проходе (Compositor) для пикселей с `Roughness < 0.2` применяется усиленный расчет зеркального отражения (Specular).

---

## 3. Реализация глиттера (Glitter)

Глиттер — это массив микроскопических зеркальных частиц, каждая из которых имеет свой наклон.

### 3.1 Генерация частиц (Noise-based Splatting)
Шейдер глиттера использует детерминированную функцию шума для расстановки "искр":
```metal
float sparkle = step(0.98, pseudo_random(pixel_coord + brush_id));
```

**Оптимизация для Legacy (A10-A12)**:
*   Вместо функции `pseudo_random` используется текстура с запеченным синим шумом (Blue Noise). Это исключает сложные вычисления на старых GPU.

### 3.2 Нормали граней (Facet Normals)
Каждой искре назначается случайный вектор нормали $\vec{N}_{facet}$. 
*   Данные сохраняются в `Attribute Texture` (канал G).
*   В момент поворота устройства, когда вектор света $\vec{L}$ совпадает с $\vec{N}_{facet}$, пиксель вспыхивает.

---

## 4. GPU Пайплайн

### 4.1 Расширенный Multi-pass
1.  **Pass 1 (Splat)**: Отрисовка в `AccumulationBuffer` (Маска + Атрибуты).
2.  **Pass 2 (Process)**: Вычисление плотности частиц и их ориентации.
3.  **Pass 3 (Composite)**: 
    *   Смешивание цвета с фоновыми слоями.
    *   Запись `RGBA` и `Material Map` в итоговые текстуры слоя.

---

## 5. Требования к памяти

*   Использование **двухканальных Argument Buffers** для передачи пар текстур (Color + Material).
*   Для экономии VRAM `Attribute Texture` может использовать формат `RG8Unorm` (2 байта на пиксель), что в 4 раза меньше основного цвета.
