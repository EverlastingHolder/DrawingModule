# Спецификация надежности и персистентности — DrawEngine

**Статус:** ✅ APPROVED (Фаза закалки)
**Версия:** 2.0 (2026-02-04)

Этот документ описывает механизмы обеспечения отказоустойчивости, протокол Write-Ahead Log (WAL), алгоритмы восстановления после сбоев и стратегии обработки критических ошибок ввода-вывода.

---

## 1. Протокол Write-Ahead Log (WAL)

WAL является единственным источником истины (Source of Truth) для незавершенных транзакций между чекпоинтами манифеста.

### 1.1 Структура записи WAL (Record Layout)

Каждая запись в WAL имеет строгий бинарный формат для обеспечения быстрой валидации и парсинга.

| Поле | Тип | Размер | Описание |
| :--- | :--- | :--- | :--- |
| **Magic** | `UInt32` | 4B | Магическое число `0x4457414C` ("DWAL"). |
| **LSSN** | `UInt64` | 8B | Log Sequence Number — монотонно растущий индекс записи. |
| **TxID** | `UUID` | 16B | Идентификатор транзакции (Stroke ID или Action ID). |
| **Type** | `UInt8` | 1B | Тип операции (`0x01: StrokeDelta`, `0x02: Metadata`, `0x03: Checkpoint`). |
| **Payload Size** | `UInt32` | 4B | Размер полезной нагрузки (LZ4 Block). |
| **Payload** | `Binary` | Var | Сжатые данные (LZ4). Для `StrokeDelta` — это дельты блоков 64x64. |
| **CRC32c** | `UInt32` | 4B | Контрольная сумма заголовка и полезной нагрузки (Castagnoli). |

### 1.2 Процесс записи (Write Pipeline)

`DataActor` управляет записью в WAL, обеспечивая атомарность:

1.  **Сериализация**: Данные дельт сжимаются LZ4.
2.  **Фрейминг**: Формируется заголовок с текущим `LSSN`.
3.  **IO Submission**: Запись в файл производится через `FileHandle`.
4.  **Стратегия Fsync**:
    -   **Шаг мазка (Stroke Step)**: `write()` без немедленного `fsync`. Позволяет ОС буферизировать мелкие записи.
    -   **Завершение мазка (Commit)**: Вызов `fsync()` для текущего WAL-файла ПЕРЕД подтверждением успешного завершения транзакции в `UndoCoordinator`.
    -   **Критические операции**: Изменения структуры слоев требуют немедленного `fsync`.

---

## 2. Алгоритм Crash Recovery (Восстановление после сбоя)

Восстановление запускается автоматически при инициализации `DrawingSession`, если обнаружено несовпадение между `manifest.json` и содержимым папки `history/`.

### 2.1 Шаги восстановления

1.  **Анализ манифеста**:
    -   Загрузка `manifest.json`. Чтение `lastCommittedLSN` и `lastCommittedTxID`.
    -   Если манифест поврежден (ошибка CRC), используется последний валидный `.bak` манифест.
2.  **Сканирование логов**:
    -   Поиск всех `.wal` файлов. Сортировка по `LSSN` в заголовке первой записи.
    -   Фильтрация записей: игнорируются все записи с `LSN <= lastCommittedLSN`.
3.  **Валидация и Replay**:
    -   Для каждой новой записи проверяется `Magic` и `CRC32c`.
    -   **Обработка битых записей**: Если последняя запись битая (неполная или ошибка CRC), чтение прекращается. WAL обрезается (truncate) до последней валидной записи.
    -   **Replay**: Валидные записи применяются к `TileSystem` и `LayerManager` в строгом порядке `LSSN`.
4.  **Консолидация состояния**:
    -   После завершения Replay создается новый `manifest.json` с актуальным `lastCommittedLSN`.
    -   Старые WAL-файлы помечаются для архивации или удаления.

---

## 3. Обработка сбоев I/O и лимиты

### 3.1 Стратегия «Мягкой деградации» (Disk Full)

`DataActor` постоянно мониторит свободное место на диске.

| Порог | Состояние | Действия |
| :--- | :--- | :--- |
| **> 500 MB** | **Healthy** | Обычная работа. |
| **100 - 500 MB** | **Warning** | Уведомление в UI. Увеличение агрессивности Stroke Coalescing. |
| **50 - 100 MB** | **Critical** | Запрет новых слоев. Принудительный сброс LZ4 RAM кэша (L2) на диск. |
| **< 50 MB** | **Emergency** | **Режим Read-Only**. Блокировка всех новых транзакций. |

### 3.2 Управление очередью (Backpressure)
При медленном диске `UndoCoordinator` активирует **Adaptive Pressure Control**:
- **Pressure > 0.4**: Увеличение порога объединения мазков (коалесинг) до 1000мс.
- **Pressure > 0.8**: Сигнал `ThrottleInput` в UI. Блокировка ввода до очистки очереди записи.

---

## 4. Управление памятью (L2 Cache)

Для L2 кэша (LZ4 RAM) используется алгоритм **SLRU (Segmented LRU)**.

*   **Лимит L2**: 1.5 ГБ сжатых данных.
*   **Сегменты**:
    -   **Protected (20%)**: Тайлы с повторным доступом. Иммунитет к выгрузке.
    -   **Probationary (80%)**: Новые тайлы. Первые кандидаты на сброс в WAL при нехватке памяти.
*   **Memory Warning**: При системном уведомлении `Probationary` сегмент немедленно сбрасывается на диск.

---

## 5. Восстановление после Device Loss (Metal)

1.  **Состояние CPU**: `StrokeProcessor` сохраняет массив точек активного мазка в памяти актора (CPU).
2.  **Re-hydration**: После пересоздания Metal-контекста, `TileSystem` лениво восстанавливает видимые тайлы.
3.  **Active Stroke Replay**: `StrokeProcessor` заново генерирует геометрию для незавершенного мазка, восстанавливая визуальное состояние на новом GPU-контексте без потери данных пользователя.

---

## 6. Гарантии атомарности

Для всех операций сохранения (Manifest, Snapshots) используется паттерн **Atomic Rename**:
1.  Запись в `filename.tmp`.
2.  `fsync()` временного файла.
3.  `rename(filename.tmp, filename)`.
4.  `fsync()` директории.
