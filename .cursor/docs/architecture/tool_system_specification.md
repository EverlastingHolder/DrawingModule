# Tool System Specification for DrawEngine

> Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ Ð¾Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ñƒ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð², ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ñ… ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸ÐµÐ¼ Ð¸ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸ÑŽ ÑÐ»Ð¾Ð¶Ð½Ñ‹Ñ… Ð²Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ñ… ÑÑ„Ñ„ÐµÐºÑ‚Ð¾Ð² (Glitter, Gloss, Fill) Ð² Ð¾Ð±Ñ‰Ð¸Ð¹ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½ Ð¾Ñ‚Ñ€Ð¸ÑÐ¾Ð²ÐºÐ¸.

**Status**: ðŸ—ï¸ DRAFT (Initial Design - 2026-02-05)

---

## 1ï¸âƒ£ ÐžÐ±Ð·Ð¾Ñ€ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ (Tool Orchestration)

Ð”Ð»Ñ Ð¾Ð±ÐµÑÐ¿ÐµÑ‡ÐµÐ½Ð¸Ñ Ð³Ð¸Ð±ÐºÐ¾ÑÑ‚Ð¸ Ð¸ 120 FPS ÑÐ¸ÑÑ‚ÐµÐ¼Ð° Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ñ€Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ð° Ð½Ð° Ñ‚Ñ€Ð¸ ÑƒÑ€Ð¾Ð²Ð½Ñ:
1.  **ToolManager (Orchestrator)**: Ð£Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ Ð¶Ð¸Ð·Ð½ÐµÐ½Ð½Ñ‹Ð¼ Ñ†Ð¸ÐºÐ»Ð¾Ð¼ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð¸ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹ Ð²Ð²Ð¾Ð´Ð°.
2.  **Tool (Configuration & State)**: Ð˜Ð¼Ð¼ÑƒÑ‚Ð°Ð±ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð° (Size, Opacity, Material Props).
3.  **Pipeline (Execution)**: Ð Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð½Ð° **Stroke-based** (Ð¿ÑƒÑ‚Ð¸) Ð¸ **Global-based** (Ð·Ð°Ð»Ð¸Ð²ÐºÐ°, Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹) Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸.

---

## 2ï¸âƒ£ ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° ToolManager

`ToolManager` ÑÐ²Ð»ÑÐµÑ‚ÑÑ ÑÐ²ÑÐ·ÑƒÑŽÑ‰Ð¸Ð¼ Ð·Ð²ÐµÐ½Ð¾Ð¼ Ð¼ÐµÐ¶Ð´Ñƒ UI Ð¸ Ð²Ñ‹Ñ‡Ð¸ÑÐ»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð°ÐºÑ‚Ð¾Ñ€Ð°Ð¼Ð¸.

### 2.1 ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð²Ð²Ð¾Ð´Ð°
*   **Stroke Tools (ÐšÐ¸ÑÑ‚ÑŒ, Ð›Ð°ÑÑ‚Ð¸Ðº, Smudge)**: Ð”Ð»Ñ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Actor Contention Ð¿Ñ€Ð¸ 120Hz, `ToolManager` Ð¿Ñ€Ð¸ Ð½Ð°Ñ‡Ð°Ð»Ðµ Ð¼Ð°Ð·ÐºÐ° (`onDown`) Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ Ð¸Ð¼Ð¼ÑƒÑ‚Ð°Ð±ÐµÐ»ÑŒÐ½Ñ‹Ð¹ `StrokeContext`. Ð’Ð²Ð¾Ð´ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ÑÑ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ Ð² `StrokeProcessor`, Ð¼Ð¸Ð½ÑƒÑ `ToolManager` Ð´Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð¼Ð°Ð·ÐºÐ° (`onUp`). Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð¸Ð½Ñ‚ÐµÑ€Ð¿Ð¾Ð»ÑÑ†Ð¸Ñ Catmull-Rom.
*   **Global Tools (Ð—Ð°Ð»Ð¸Ð²ÐºÐ°, Ð“Ñ€Ð°Ð´Ð¸ÐµÐ½Ñ‚)**: Ð’Ð²Ð¾Ð´ Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ÑÑ `ToolManager`, Ð¸ Ð¿Ñ€Ð¸ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ð¸ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, `onTap`) Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ `GlobalOperationProcessor`.

### 2.2 Tool State & Material Map
ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ Ð¼Ð¾Ð¶ÐµÑ‚ Ð½ÐµÑÑ‚Ð¸ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑÐ²Ð¾Ð¹ÑÑ‚Ð²Ð° Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÑŽÑ‚ÑÑ Ð² **Sidecar Textures**.

| ÐšÐ°Ð½Ð°Ð» | ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ | Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ | ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ |
| :--- | :--- | :--- | :--- |
| **Material.R** | **Viscosity** (Ð’ÑÐ·ÐºÐ¾ÑÑ‚ÑŒ) | R8Unorm | Ð’Ð»Ð¸ÑÐµÑ‚ Ð½Ð° Ñ‚Ð¾Ð»Ñ‰Ð¸Ð½Ñƒ ÑÐ»Ð¾Ñ Ð¸ Ð±Ð»Ð¸ÐºÐ¸ (Ð´Ð»Ñ Lip Gloss). |
| **Material.G** | **Glitter Density** | G8Unorm | ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒ Ð¿Ð¾ÑÐ²Ð»ÐµÐ½Ð¸Ñ Ð±Ð»ÐµÑÑ‚ÐºÐ¸ Ð² Ð´Ð°Ð½Ð½Ð¾Ð¹ Ñ‚Ð¾Ñ‡ÐºÐµ. |
| **Material.B** | **Roughness** | B8Unorm | Ð¨ÐµÑ€Ð¾Ñ…Ð¾Ð²Ð°Ñ‚Ð¾ÑÑ‚ÑŒ Ð´Ð»Ñ PBR-ÑÐ¼ÐµÑˆÐ¸Ð²Ð°Ð½Ð¸Ñ. |

---

## 3ï¸âƒ£ Ð¡Ð»Ð¾Ð¶Ð½Ñ‹Ðµ Ð²Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ ÑÑ„Ñ„ÐµÐºÑ‚Ñ‹

### 3.1 Glitter & Shimmer
Ð”Ð»Ñ ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ð±Ð»ÐµÑÑ‚Ð¾Ðº Ð¿Ñ€Ð¸ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ **Deterministic Spatial Hashing**.
*   **ÐÐ»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼**: `Hash(floor(WorldPos / ParticleSize))` Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¸ Ð¾Ñ€Ð¸ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ "Ð¼Ð¸ÐºÑ€Ð¾-Ð·ÐµÑ€ÐºÐ°Ð»Ð°".
*   **Shimmering**: Ð˜Ð½Ñ‚ÐµÐ½ÑÐ¸Ð²Ð½Ð¾ÑÑ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ ÑƒÐ³Ð»Ð° Ð¼ÐµÐ¶Ð´Ñƒ Ð²ÐµÐºÑ‚Ð¾Ñ€Ð¾Ð¼ Ð¾ÑÐ²ÐµÑ‰ÐµÐ½Ð¸Ñ (Ð¸Ð· Ð³Ð¸Ñ€Ð¾ÑÐºÐ¾Ð¿Ð°) Ð¸ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÑŽ Ð¼Ð¸ÐºÑ€Ð¾-Ð·ÐµÑ€ÐºÐ°Ð»Ð°.

### 3.2 Lip Gloss (Ð’ÑÐ·ÐºÐ¸Ð¹ Ð±Ð»ÐµÑÐº)
Ð˜Ð¼Ð¸Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ð¾Ð±ÑŠÐµÐ¼Ð½Ñ‹Ð¹ ÑÐ»Ð¾Ð¹ Ð¶Ð¸Ð´ÐºÐ¾ÑÑ‚Ð¸.
*   **Ð’Ñ‹ÑÐ¾Ñ‚Ð° (Height Map)**: Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸: $H = Pressure \times (1.0 + k_{visc} / (1.0 + Velocity))$.
*   **Ð ÐµÐ½Ð´ÐµÑ€Ð¸Ð½Ð³**: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ MatCap Ñ‚ÐµÐºÑÑ‚ÑƒÑ€ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ñ… Ð¸ Ñ€ÐµÐ°Ð»Ð¸ÑÑ‚Ð¸Ñ‡Ð½Ñ‹Ñ… Ð¾Ñ‚Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹ Ð½Ð° ÐºÑ€Ð°ÑÑ… "ÐºÐ°Ð¿ÐµÐ»ÑŒ".

---

## 4ï¸âƒ£ Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ (GlobalOperationProcessor)

Ð”Ð»Ñ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð², Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‰Ð¸Ñ… Ð½Ðµ Ð¿Ð¾ Ð¿ÑƒÑ‚Ð¸ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, **Bucket Fill**).

### 4.1 Bucket Fill (JFA)
*   **ÐÐ»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼**: Jump Flooding Algorithm Ð½Ð° GPU.
*   **Incremental JFA**: Ð”Ð»Ñ 32k Ñ…Ð¾Ð»ÑÑ‚Ð¾Ð² JFA Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð¸Ñ‚ÐµÑ€Ð°Ñ‚Ð¸Ð²Ð½Ð¾ (Ð¿Ð¾ Ñ€ÐµÐ³Ð¸Ð¾Ð½Ð°Ð¼) Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ `MTLFence`, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð¿Ð¾Ñ‚Ð¾Ðº Ñ€ÐµÐ½Ð´ÐµÑ€Ð¸Ð½Ð³Ð° Ð±Ð¾Ð»ÐµÐµ Ñ‡ÐµÐ¼ Ð½Ð° 2Ð¼Ñ Ð·Ð° Ð¿Ñ€Ð¾Ñ…Ð¾Ð´.
*   **ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Undo**: 
    *   Ð•ÑÐ»Ð¸ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ñ Ð·Ð°Ñ‚Ñ€Ð°Ð³Ð¸Ð²Ð°ÐµÑ‚ > 50% Ñ‚Ð°Ð¹Ð»Ð¾Ð², `UndoManager` Ð´ÐµÐ»Ð°ÐµÑ‚ ÑÐ½Ð°Ð¿ÑˆÐ¾Ñ‚ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐ»Ð¾Ñ.
    *   Ð¢Ð°Ð¹Ð»Ñ‹ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´ÑÑ‚ÑÑ Ð² ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ `Solid(Color)`, Ð¾ÑÐ²Ð¾Ð±Ð¾Ð¶Ð´Ð°Ñ Ñ„Ð¸Ð·Ð¸Ñ‡ÐµÑÐºÑƒÑŽ VRAM.
    *   **Background Snapshotting**: Ð¡Ð½Ð°Ð¿ÑˆÐ¾Ñ‚ Ð´Ð»Ñ Bucket Fill Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾ Ñ‡ÐµÑ€ÐµÐ· CoW-Ð¼ÐµÑ…Ð°Ð½Ð¸Ð·Ð¼ `TileSystem`, Ð½Ðµ Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÑ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð½Ð¾Ð²Ñ‹Ñ… Ñ‚Ð¾Ñ‡ÐµÐº Ð¼Ð°Ð·ÐºÐ°.
*   **Gap Closing**: Ð”Ð²ÑƒÑ…Ð¿Ñ€Ð¾Ñ…Ð¾Ð´Ð½Ð°Ñ Ð¼Ð¾Ñ€Ñ„Ð¾Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° (Dilation -> Fill -> Erode) Ð´Ð»Ñ Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¼ÐµÐ»ÐºÐ¸Ñ… Ñ€Ð°Ð·Ñ€Ñ‹Ð²Ð¾Ð² Ð² ÐºÐ¾Ð½Ñ‚ÑƒÑ€Ð°Ñ….

---

## 5ï¸âƒ£ Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ñ Core Actors

### 5.1 StrokeProcessor
*   ÐŸÑ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚ `ToolSettings` Ð´Ð»Ñ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð° Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² (Ñ€Ð°Ð·Ð¼ÐµÑ€ Ð¾Ñ‚ Ð´Ð°Ð²Ð»ÐµÐ½Ð¸Ñ, Ð²ÑÐ·ÐºÐ¾ÑÑ‚ÑŒ Ð¾Ñ‚ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚Ð¸).
*   Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÑ‚ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ð¹ `GeometrySnapshot`, Ð²ÐºÐ»ÑŽÑ‡Ð°ÑŽÑ‰Ð¸Ð¹ Ð°Ñ‚Ñ€Ð¸Ð±ÑƒÑ‚Ñ‹ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ð°.

### 5.2 TileSystem
*   Ð£Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ Ð°Ð»Ð»Ð¾ÐºÐ°Ñ†Ð¸ÐµÐ¹ `Sidecar Textures` Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ ÑÐ»Ð¾ÐµÐ², Ð³Ð´Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ ÑÐ»Ð¾Ð¶Ð½Ñ‹Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹.
*   ÐžÐ±ÐµÑÐ¿ÐµÑ‡Ð¸Ð²Ð°ÐµÑ‚ Copy-on-Write Ð´Ð»Ñ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ð°.
*   **Selective Sidecar Snapshoting**: `UndoManager` Ð¸ `DataActor` Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°Ñ‚ÑŒ Ð¼Ð°ÑÐºÑƒ ÐºÐ°Ð½Ð°Ð»Ð¾Ð². Ð•ÑÐ»Ð¸ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ Ð½Ðµ Ð¼ÐµÐ½ÑÐ» `Material.B`, sidecar-Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÑ‚Ð¾Ð³Ð¾ ÐºÐ°Ð½Ð°Ð»Ð° Ð½Ðµ Ð²ÐºÐ»ÑŽÑ‡Ð°ÑŽÑ‚ÑÑ Ð² ÑÐ½Ð°Ð¿ÑˆÐ¾Ñ‚.
*   **Lower Residency Priority**: Sidecar-Ñ‚ÐµÐºÑÑ‚ÑƒÑ€Ñ‹ Ð¸Ð¼ÐµÑŽÑ‚ Ð±Ð¾Ð»ÐµÐµ Ð½Ð¸Ð·ÐºÐ¸Ð¹ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ Ð² `ResidencyManager` Ð¿Ð¾ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸ÑŽ Ñ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ð¼ RGBA16F ÑÐ»Ð¾ÐµÐ¼. ÐŸÑ€Ð¸ Ð´ÐµÑ„Ð¸Ñ†Ð¸Ñ‚Ðµ Ð¿Ð°Ð¼ÑÑ‚Ð¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ð° ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð³Ñ€ÑƒÐ¶Ð°ÐµÑ‚ Sidecar-Ð´Ð°Ð½Ð½Ñ‹Ðµ, Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ð°Ñ Ð²Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ ÑÑ„Ñ„ÐµÐºÑ‚Ñ‹ (Glitter/Gloss), Ð½Ð¾ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ñ€Ð¸ÑÑƒÐ½ÐºÐ°.

### 5.3 UndoManager
*   ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° **Atomic Global Actions** (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, "Fill Layer").
*   ÐšÐ¾Ð°Ð»ÐµÑÑ†ÐµÐ½Ñ†Ð¸Ñ Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ñ… Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð° (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð°).

---

## 6ï¸âƒ£ Performance Limits (120 FPS Target)

*   **Shader Occupancy**: ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ð² **32 Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°** Ð½Ð° Ð¿Ð¾Ñ‚Ð¾Ðº Ð´Ð»Ñ Ð²ÑÐµÑ… Material-ÑˆÐµÐ¹Ð´ÐµÑ€Ð¾Ð².
*   **Bandwidth**: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ `Memoryless` Ñ‚ÐµÐºÑÑ‚ÑƒÑ€ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð¼ÐµÐ¶ÑƒÑ‚Ð¾Ñ‡Ð½Ñ‹Ñ… Ð²Ñ‹Ñ‡Ð¸ÑÐ»ÐµÐ½Ð¸Ð¹ Ð¼Ð°ÑÐ¾Ðº Ð±Ð»ÐµÑÑ‚Ð¾Ðº.
*   **SRAM Usage**: ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÑ„Ñ„ÐµÐºÑ‚Ð¾Ð² Ð² Ñ€Ð°Ð¼ÐºÐ°Ñ… Ð°Ð¿Ð¿Ð°Ñ€Ð°Ñ‚Ð½Ð¾Ð³Ð¾ Ñ‚Ð°Ð¹Ð»Ð° 32x32 (Apple Silicon Tile Shaders).
*   **Pipeline Caching**: `ToolManager` Ð¾Ð±ÑÐ·Ð°Ð½ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ `PipelineCache` Ð´Ð»Ñ Ð¿Ñ€ÐµÐ´Ð²Ð°Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ð¸ Ð¸ Ð¿ÐµÑ€ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ PSO (Pipeline State Objects). ÐŸÑ€ÑÐ¼Ð¾Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ PSO Ð²Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð¾Ñ‚Ñ€Ð¸ÑÐ¾Ð²ÐºÐ¸ Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½Ð¾.
*   **Residency Budget**: Sidecar-Ñ‚ÐµÐºÑÑ‚ÑƒÑ€Ñ‹ Ð½Ðµ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð·Ð°Ð½Ð¸Ð¼Ð°Ñ‚ÑŒ Ð±Ð¾Ð»ÐµÐµ 25% Ð¾Ñ‚ Ð¾Ð±Ñ‰ÐµÐ³Ð¾ Ð±ÑŽÐ´Ð¶ÐµÑ‚Ð° VRAM (128MB Ð¸Ð· 512MB).

---

## 7ï¸âƒ£ Public API (Draft)

```swift
public protocol Tool: Sendable {
    var id: String { get }
    var capabilities: [ToolCapability] { get }
    /// Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð´ÐµÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ñ€ Ð´Ð»Ñ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ð°.
    var pipelineDescriptor: ToolPipelineDescriptor { get } 
}

public struct ToolPipelineDescriptor: Hashable, Sendable {
    let effectID: String
    let fragmentFunctionName: String
    let constants: [String: Float]
}

internal actor ToolPipelineCache {
    private var cache: [ToolPipelineDescriptor: MTLComputePipelineState]
    func pipeline(for descriptor: ToolPipelineDescriptor, device: MTLDevice) async throws -> MTLComputePipelineState
}

public enum ToolCapability {
    case pressureSensitivity
    case materialModification(channels: Set<MaterialChannel>)
    case globalExecution
}

public actor GlobalOperationProcessor {
    func executeFill(at point: CGPoint, color: SIMD4<Float>, tolerance: Float) async throws -> CGRect
}
```
