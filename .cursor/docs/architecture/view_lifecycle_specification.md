# MetalDrawView Specification & Lifecycle

**Status**: ✅ REFINED (Audit V4 2026-01-31 - Latency Optimized)

> Этот документ описывает роль, ответственность и жизненный цикл основного визуального компонента SDK — `MetalDrawView`.

---

## 1️⃣ Роль и Ответственность

`MetalDrawView` (наследник `MTKView`) является "окном" в мир холста. Она не содержит логики рисования, а выступает в роли посредника (Bridge).

### Основные задачи:
1.  **Input Abstraction**: Перехват системных событий ввода (Touch на iOS, Mouse/Stylus на macOS) и их нормализация.
2.  **Predicted Touches**: Использование `UIEvent.predictedTouches` для минимизации задержки ввода на 120Hz экранах.
3.  **Viewport Management**: Определение того, какая часть глобального холста (Canvas) видна в данный момент.
4.  **Coordinate Mapping**: Математический перевод координат из пространства экрана (Screen Space) в пространство холста (World Space).
5.  **Display Orchestration**: Вызов отрисовщика (`TileRenderer`) для вывода содержимого тайлов на экран.

---

## 2️⃣ Взаимодействие компонентов

`MetalDrawView` выступает в роли пассивного окна, визуализирующего состояние сессии. Ответственность распределена следующим образом:

*   **DrawingSession (Владелец)**: Центральный объект бизнес-логики. Владеет `TileSystem`, `DrawEngine`, `UndoManager` и настройками кисти. Существует независимо от вьюхи.
*   **MetalDrawView (Окно)**: Владеет только своим `TileRenderer`. Хранит слабую ссылку на `DrawingSession`. Отвечает за трансляцию ввода и запуск цикла отрисовки.
*   **MTLFence Synchronization**: Использование GPU fences для синхронизации между отрисовкой мазка и захватом снапшота для Undo. Это позволяет избежать пузырей (bubbles) в конвейере и сохранить 120 FPS.
*   **Triple Buffering**: Использование `DispatchSemaphore(value: 3)` для предотвращения блокировок CPU при ожидании GPU, что критично для 120 FPS.
*   **TileRenderer (Исполнитель)**: Подчиненный объект вьюхи, который умеет рисовать данные из `DrawingSession` в текстуру `drawable`. Использует TLDT для оптимизации отрисовки только измененных областей.

---

## 3️⃣ Жизненный цикл (Lifecycle)

### 3.1 Инициализация (Initialization)
1.  **Привязка к Сессии**: Вьюха инициализируется с существующим объектом `DrawingSession`.
2.  **Настройка Metal**: Создание `CAMetalLayer`, установка `device` и `pixelFormat`.
3.  **Создание Renderer**: Инициализация `TileRenderer`, привязанного к Metal-устройству вьюхи.
4.  **Подготовка Viewport**: Установка начального зума и смещения на основе `canvasSize` из сессии.

### 3.5 Завершение (Deinitialization)
1.  **Invalidation**: При уничтожении (deinit) вьюха обязана вызвать `session.invalidate()`.
2.  **Cleanup**: Остановка `DisplayLink`, освобождение ресурсов `TileRenderer`.
3.  **Safety**: Гарантирует остановку фоновых задач `StrokeProcessor` и атомарный Rollback незавершенного мазка.

### 3.2 Цикл ввода (Input Loop)
1.  **Capture**: Получение сырых событий (`UITouch` / `NSEvent`).
2.  **Prediction**: Извлечение предсказанных точек (`predictedTouches`) для отрисовки "опережающего" штриха.
3.  **Normalize**: Превращение их в `RawStrokePoint` (позиция, давление, наклон).
4.  **Map**: Перевод координат точки с учетом текущего `zoom` и `offset` вьюхи.
5.  **Forward**: Передача потока точек в `DrawEngine` через `DrawingSession`.

### 3.3 Цикл отображения (Render Loop)
Работает по расписанию `DisplayLink` (60/120 FPS):
1.  **Wait**: Ожидание освобождения буфера через `semaphore.wait()`.
2.  **Culling**: Вьюха вычисляет список тайлов, которые попадают в её текущий прямоугольник (Viewport).
3.  **Render Pass**:
    *   `TileRenderer` рисует "запеченные" тайлы.
    *   `TileRenderer` рисует "активный штрих" из `LiveStrokeBuffer` (включая предсказанные точки).
4.  **Present**: Вывод кадра на экран.
5.  **Signal**: Вызов `semaphore.signal()` в `addCompletedHandler` командного буфера.

### 3.4 Трансформация (Pan & Zoom)
1.  Пользователь выполняет жест (например, через `UIScrollView` или встроенный GestureRecognizer).
2.  View обновляет свои внутренние параметры `zoomScale` и `contentOffset`.
3.  Эти параметры мгновенно передаются в матрицу проекции Metal при следующем шаге `draw`.
4.  Холст перерисовывается без потери четкости.

---

## 4️⃣ Системы координат

В нашей системе существует три пространства:

1.  **Screen Space (пиксели экрана)**: От `(0,0)` до `(viewWidth, viewHeight)`. Здесь живут сырые касания.
2.  **World Space (пиксели холста)**: От `(0,0)` до `(canvasWidth, canvasHeight)`. Здесь живут мазки и тайлы. Использует **`Double Precision`** для всех расчетов геометрии, что критично для холстов сверхвысокого разрешения.
3.  **NDC Space (Normalized Device Coordinates)**: Пространство Metal от `-1` до `1`. Сюда координаты переводятся матрицей проекции.

`MetalDrawView` — единственный компонент, который знает о существовании **Screen Space**. Все остальные компоненты работают исключительно в **World Space**.

---

## 5️⃣ Публичный API (Абстракция)

Вьюха предоставляет разработчику:
*   Свойства для управления отображением (зум, сетка).
*   Методы для экспорта ("что я сейчас вижу" или "весь холст").
*   Делегат для отслеживания состояния (начало/конец рисования, изменение масштаба).
