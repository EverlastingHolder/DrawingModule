# Project Knowledge Base: DrawEngine

**Status**: ‚úÖ REFINED (Audit V4 2026-01-31)

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–ª—é—á–µ–≤—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏.

## üèõ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
*   **–¢–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞**: –•–æ–ª—Å—Ç —Ä–∞–∑–±–∏—Ç –Ω–∞ —Ç–∞–π–ª—ã 256—Ö256. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ **MTLSparseTexture** –¥–ª—è 32k+ —Ö–æ–ª—Å—Ç–æ–≤.
*   **3-Level Caching**: –ì–∏–±—Ä–∏–¥–Ω–∞—è –ø–∞–º—è—Ç—å: VRAM (512MB) -> LZ4 RAM (Undo/Redo) -> Disk (LZ4 Regions).
*   **Global Occupancy Map**: –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è –±–∏—Ç–æ–≤–∞—è –º–∞—Å–∫–∞ –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –ø—É—Å—Ç—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π –ø—Ä–∏ –∫–æ–º–ø–æ–∑–∏—Ç–∏–Ω–≥–µ.
*   **4-Actor Model**: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ `DrawingSession` (UI), `StrokeProcessor` (Math), `TileSystem` (GPU) –∏ `DataActor` (I/O).
*   **Residency Manager**: –ö–æ–Ω—Ç—Ä–æ–ª—å —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç–∏ —á–µ—Ä–µ–∑ 
`MTLResidencySet`, LRU –∏ **Layer Priority** (Active > Visible 
> Background > Invisible).
*   **FrameContext & Handshake**: –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –±–µ–∑ Actor Hopping —á–µ—Ä–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤.
*   **Package-First Architecture (.drawproj)**: –•—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –∫–∞–∫ –ø–∞–∫–µ—Ç–∞ —Å –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–º –ø–æ–∫–æ–ª–µ–Ω–∏–π (**Global Transaction Index**) –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π.

## üíæ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é –∏ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è
*   **LZ4 Snapshot Pipeline**: –°–∂–∞—Ç–∏–µ Undo-—Å–Ω–∞–ø—à–æ—Ç–æ–≤ –≤ RAM.
*   **Export-Streaming Mode**: –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º —ç–∫—Å–ø–æ—Ä—Ç–∞ 32k+ —Ö–æ–ª—Å—Ç–æ–≤ —Å –æ–±—Ö–æ–¥–æ–º LRU –∏ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º Backpressure (128MB RAM limit).
*   **Pre-emptive Unfolding**: –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ Solid-—Ç–∞–π–ª–æ–≤ —Å 100ms lookahead (–Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–µ–∫—Ç–æ—Ä–æ–≤ —Å–∫–æ—Ä–æ—Å—Ç–∏/—É—Å–∫–æ—Ä–µ–Ω–∏—è).
*   **Zero-Copy**: –ü–µ—Ä–µ–¥–∞—á–∞ –≥–µ–æ–º–µ—Ç—Ä–∏–∏ —á–µ—Ä–µ–∑ `.shared` MTLBuffers.

## üìê –¢–æ—á–Ω–æ—Å—Ç—å –∏ –ê–ª–≥–æ—Ä–∏—Ç–º—ã
*   **Double Precision CPU**: –í—Å–µ —Ä–∞—Å—á–µ—Ç—ã WorldSpace –≤ `Double` –¥–ª—è —Ö–æ–ª—Å—Ç–æ–≤ –¥–æ 100k px.
*   **Centripetal Catmull-Rom**: –°–ø–ª–∞–π–Ω—ã –±–µ–∑ –ø–µ—Ç–µ–ª—å ($\alpha=0.5$) —Å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º —à–∞–≥–æ–º –∏ —ç–∫—Å—Ç—Ä–∞–ø–æ–ª—è—Ü–∏–µ–π –≥—Ä–∞–Ω–∏—Ü.
*   **Relative GPU Coordinates**: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è `WorldPos - ViewAnchor` –≤–æ `Float` –Ω–∞ GPU.

## üé® –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è
*   **RGBA16Float**: HDR –∫–æ–Ω–≤–µ–π–µ—Ä (—è—Ä–∫–æ—Å—Ç—å > 1.0).
*   **Tile-based Compositing**: –°–º–µ—à–∏–≤–∞–Ω–∏–µ —Å–ª–æ–µ–≤ –≤ –æ–¥–∏–Ω –ø—Ä–æ—Ö–æ–¥ –≤–Ω—É—Ç—Ä–∏ **on-chip SRAM (Imageblocks)** –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è 120 FPS.
*   **Multi-pass Brush Pipeline**: Splat-Process-Composite –∫–æ–Ω–≤–µ–π–µ—Ä –¥–ª—è Smudge/Blur —ç—Ñ—Ñ–µ–∫—Ç–æ–≤.
*   **Register Pressure Limits**: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Smudge-—è–¥—Ä–∞ (32 —Ä–µ–≥–∏—Å—Ç—Ä–∞) –¥–ª—è 100% occupancy –Ω–∞ Apple Silicon.
*   **Deferred Mipmapping**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–ø–æ–≤ –≤ Idle-–ø–µ—Ä–∏–æ–¥—ã –∏–ª–∏ –Ω–∞ Stroke End.
*   **HDR to SDR Export**: ACES/Reinhard Tonemapping —Å –¥–∏–∑–µ—Ä–∏–Ω–≥–æ–º –¥–ª—è 8-–±–∏—Ç–Ω–æ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∞.

## üßµ –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (Swift 6)
*   **Strict Concurrency**: –ò–∑–æ–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ Actors –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª `Sendable`.
*   **LayerStackSnapshot**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–º–º—É—Ç–∞–±–µ–ª—å–Ω—ã—Ö —Å–Ω–∏–º–∫–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–ª–æ–µ–≤ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è Actor Hopping –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ.
*   **Cooperative Cancellation**: –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö Undo.

## üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫
*   **Language**: Swift 6.0, Metal 3.0.
*   **API**: MTLHeap, MTLSparseTexture, Compute Shaders.
*   **OS**: iOS 15.0+ / macOS 12.0+.
